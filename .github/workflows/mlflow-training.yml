name: MLflow Model Training CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'MLProject/**'

  pull_request:
    branches:
      - main

  workflow_dispatch:
    inputs:
      n_estimators:
        description: 'Number of trees'
        required: false
        default: '100'
      max_depth:
        description: 'Maximum tree depth'
        required: false
        default: '10'

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.12.7
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.7'

      - name: Check Env
        run: |
          echo "Python version:"
          python --version
          echo "Pip version:"
          pip --version
          echo "Working directory:"
          pwd
          echo "Repository structure:"
          ls -la

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update
          sudo apt-get install -y graphviz
          pip install mlflow==2.19.0 pandas numpy scikit-learn matplotlib seaborn

      - name: Run MLflow Project
        run: |
          cd MLProject
          mlflow run . \
            --experiment-name "Transactions_CI_CD_Training" \
            --env-manager=local \
            -P n_estimators=${{ github.event.inputs.n_estimators || 100 }} \
            -P max_depth=${{ github.event.inputs.max_depth || 10 }}

      - name: Get latest MLflow run_id
        id: get_run_id
        run: |
          echo "Searching for MLflow runs..."
          echo "Current directory:"
          pwd
          echo "Files in current directory:"
          ls -la
          echo "Checking for mlruns directories:"
          find . -name "mlruns" -type d
          echo "Contents of mlruns (if exists):"
          find . -path "*/mlruns/*" -type d | head -30

          # Try to find in current directory
          LATEST_RUN=$(find . -path "*/mlruns/*/*" -type d -name "20*" 2>/dev/null | sort -r | head -1)

          if [ -z "$LATEST_RUN" ]; then
            echo "No run found with pattern 20*, searching all run directories..."
            LATEST_RUN=$(find . -path "*/mlruns/*/*" -mindepth 0 -maxdepth 0 -type d 2>/dev/null | grep -v "meta.yaml" | sort -r | head -1)
          fi

          if [ -z "$LATEST_RUN" ]; then
            echo "Trying alternative search pattern..."
            LATEST_RUN=$(find . -type f -name "*.pkl" 2>/dev/null | head -1 | xargs dirname | xargs dirname 2>/dev/null)
          fi

          if [ -z "$LATEST_RUN" ]; then
            echo "Error: No MLflow run directory found!"
            echo "Directory structure:"
            find . -type d | head -50
            exit 1
          fi

          RUN_ID=$(basename "$LATEST_RUN")
          echo "Latest Run ID: $RUN_ID"
          echo "Latest Run Path: $LATEST_RUN"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_path=$LATEST_RUN" >> $GITHUB_OUTPUT

      - name: Install Python dependencies
        run: |
          pip install docker

      - name: Upload to Github Repository
        run: |
          mkdir -p model_artifacts
          LATEST_RUN="${{ steps.get_run_id.outputs.run_path }}"

          if [ -d "$LATEST_RUN/artifacts" ]; then
            cp -r "$LATEST_RUN"/artifacts/* model_artifacts/ || true
            echo "Run ID: ${{ steps.get_run_id.outputs.run_id }}" > model_artifacts/run_info.txt
            echo "Timestamp: $(date)" >> model_artifacts/run_info.txt
            echo "Commit: ${{ github.sha }}" >> model_artifacts/run_info.txt
          fi

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add model_artifacts/ || true
          git diff --staged --quiet || git commit -m "Add model artifacts from run #${{ github.run_number }} [automated]"
          git push

      - name: Build Docker Model
        run: |
          cd MLProject
          docker build -t transactions-mlops-ci:latest -f- . <<EOF
          FROM python:3.12.7-slim

          WORKDIR /app

          COPY conda.yaml .
          RUN pip install --no-cache-dir pandas==2.3.3 numpy==2.3.4 \
              scikit-learn==1.5.0 mlflow==2.19.0 matplotlib==3.9.0 seaborn==0.13.2

          COPY . .

          EXPOSE 5000

          CMD ["mlflow", "run", ".", "--no-conda"]
          EOF

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag Docker image
        if: github.event_name != 'pull_request'
        run: |
          docker tag transactions-mlops-ci:latest ${{ secrets.DOCKER_USERNAME }}/transactions-mlops-ci:latest
          docker tag transactions-mlops-ci:latest ${{ secrets.DOCKER_USERNAME }}/transactions-mlops-ci:v${{ github.run_number }}

      - name: Push Docker image
        if: github.event_name != 'pull_request'
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/transactions-mlops-ci:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/transactions-mlops-ci:v${{ github.run_number }}
          echo "Docker image pushed successfully!"
          echo "Image: ${{ secrets.DOCKER_USERNAME }}/transactions-mlops-ci:latest"
          echo "Image: ${{ secrets.DOCKER_USERNAME }}/transactions-mlops-ci:v${{ github.run_number }}"
